---
title: "TS model diagnostics"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(drake)
library(dplyr)
library(ggplot2)

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("drake", "drake-cache.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)

```

```{r load stuff}
loadd(all_models, cache = cache)

model_names <- lapply(as.list(names(all_models)), 
                      FUN = function(model_result_name)
                        return(strsplit(model_result_name, "_")[[1]]))

names(model_names) = 1:length(model_names)
model_names <- bind_rows(model_names) %>%
  t()

model_names <- as.data.frame(model_names) %>%
  select(-V1) %>%
  rename(seed = V2,
         k = V3,
         ncpts = V4,
         cov = V5,
         nit = V6) %>%
  mutate(k = factor(k),
         ncpts = as.factor(ncpts),
         obj_index = row_number(),
         full_name = names(all_models)) %>%
  mutate(k = factor(k, levels = as.character(sort(as.numeric(levels(k))))))

```


### Runtime of TS models (in seconds)
```{r runtime}
runtime <- data.frame(
  full_name = names(all_models),
  runtime = vapply(all_models,
                   FUN = function(model_result)
                     return(model_result$timing$toc["elapsed"] -
                              model_result$timing$tic["elapsed"]),
                   FUN.VALUE = 8),
  row.names = NULL, stringsAsFactors = F)

model_info <- left_join(model_names, runtime, by = "full_name")


runtime_plot <- ggplot(data = model_info, aes(x = nit, y = runtime, color = k)) +
  geom_boxplot() +
  facet_grid(rows = vars(cov, ncpts), cols = vars(k), switch = "y") +
  theme_bw() +
  scale_color_viridis_d(end = .8)
runtime_plot

```

## AICc of TS models

```{r aicc}
aiccs <- data.frame(
  aicc = vapply(all_models,
                FUN = function(ts_result)
                  return(LDATS::AICc(ts_result$ts[[1]])),
                FUN.VALUE = 30),
  aic = vapply(all_models,
               FUN = function(ts_result)
                 return(ts_result$ts[[1]]$AIC),
               FUN.VALUE = 30),
  full_name = names(all_models),
  row.names = NULL, stringsAsFactors = F)

model_info <- left_join(model_info, aiccs, by = "full_name")

aic_plot <- ggplot(data = model_info, aes(x = nit, y = aic, color = k)) +
  geom_boxplot() +
  facet_grid(rows = vars(cov, ncpts), cols = vars(k), switch = "y") +
  theme_bw() +
  scale_color_viridis_d(end = .8)

aic_plot

```

Why do matching models have the same AIC? They have different formulas and different projections:

```{r dig in}

loadd(models_1977_2_0_time_100, cache = cache)
loadd(models_1977_2_0_intercept_100, cache = cache)

models_1977_2_0_time_100$ts[[1]]$formula
models_1977_2_0_intercept_100$ts[[1]]$formula

plot(models_1977_2_0_time_100$ts[[1]])

plot(models_1977_2_0_intercept_100$ts[[1]])


loadd(models_1977_2_1_time_100, cache = cache)
loadd(models_1977_2_1_intercept_100, cache = cache)

models_1977_2_1_time_100$ts[[1]]$formula
models_1977_2_1_intercept_100$ts[[1]]$formula

plot(models_1977_2_1_time_100$ts[[1]])

plot(models_1977_2_1_intercept_100$ts[[1]])

```

Interestingly, AICc matches across nb iterations but does change for model configurations. My current guess is that this is so few iterations, 10000 vs. 100 doesn't give substantially different fits. More iterations might start to show changes - stay tuned for 100k from the hipergator. 

```{r aiccs}


aicc_plot <- ggplot(data = model_info, aes(x = nit, y = aicc, color = k)) +
  geom_boxplot() +
  facet_grid(rows = vars(cov, ncpts), cols = vars(k), switch = "y") +
  theme_bw() +
  scale_color_viridis_d(end = .8)

aicc_plot

```

## Parameter estimates over iterations

```{r clean up space, include = F}
rm(models_1977_2_0_time_100)
rm(models_1977_2_0_intercept_100)
rm(models_1977_2_1_time_100)
rm(models_1977_2_1_intercept_100)
```

### Etas (coefficients within segments)

```{r etas, fig.width = 8, fig.height= 40}

get_etas <- function(ts_result) {
  etas_df <- ts_result$ts[[1]]$etas %>%
    as.data.frame() %>%
    mutate(draw = row_number())
  
  if(max(etas_df$draw) > 1000) {
    draws_to_keep <- seq(1, .99 * max(etas_df$draw), by = max(etas_df$draw) / 10)
    
    draws_to_keep <- c(draws_to_keep, seq(max(draws_to_keep),
                                           max(etas_df$draw),
                                           by = max(etas_df$draw) / 100))
    draws_to_keep <- unique(draws_to_keep)
    
    etas_df <- filter(etas_df, draw %in% draws_to_keep)
  }
  
  
  return(etas_df)
}

etas <- lapply(all_models, FUN = get_etas)

etas <- bind_rows(etas, .id = "full_name") %>%
  tidyr::gather(-draw, -full_name, key = "parameter", value = "estimate") %>%
  filter(!is.na(estimate))

etas_info <- left_join(etas, model_info, by = "full_name") %>%
  filter(k %in% c(2),
         as.character(ncpts) %in% c("0", "1"))


etas_plot <- ggplot(data = etas_info, aes(x = draw, y = estimate, color = k)) +
  geom_line() +
  theme_bw() +
  facet_wrap(facets = c("ncpts", "cov", "k", "nit"), scales = "free", strip.position = "top", ncol = 1, drop = TRUE)  +
  scale_color_viridis_d(end = .8)
etas_plot

```

### Rhos (changepoint locations)
```{r rhos, fig.width = 8, fig.height= 80}

get_rhos <- function(ts_result) {
  rhos_df <- ts_result$ts[[1]]$rhos %>%
    as.data.frame() %>%
    mutate(draw = row_number())
  
   if(max(rhos_df$draw) > 1000) {
    draws_to_keep <- seq(1, .99 * max(rhos_df$draw), by = max(rhos_df$draw) / 10)
    
    draws_to_keep <- c(draws_to_keep, seq(max(draws_to_keep),
                                           max(rhos_df$draw),
                                           by =  max(rhos_df$draw) / 100))
    draws_to_keep <- unique(draws_to_keep)
    
    rhos_df <- filter(rhos_df, draw %in% draws_to_keep)
  }
  
  return(rhos_df)
}

rhos <- lapply(all_models, FUN = get_rhos)

rhos <- bind_rows(rhos, .id = "full_name") %>%
  tidyr::gather(-draw, -full_name, key = "changepoint", value = "estimate") %>%
  filter(!is.na(estimate)) %>%
  mutate(changepoint = substr(changepoint, 2, nchar(changepoint)))

rhos_info <- left_join(rhos, model_info, by = "full_name") %>%
  filter(k %in% c(2, 12),
         as.character(ncpts) %in% c("1", "4"))


rhos_plot <- ggplot(data = rhos_info, aes(x = draw, y = estimate, color = changepoint)) +
  geom_line() +
  theme_bw() +
  facet_wrap(facets = c("ncpts", "cov", "k", "nit"), scales = "free", strip.position = "top", ncol = 1, drop = TRUE) +
  scale_color_viridis_d(end = .8)
rhos_plot

```